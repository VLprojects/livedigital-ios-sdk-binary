CallPusher — инструмент для отправки тестовых VOIP-пушей.

# Запуск

CappPusher использует Python 3. Для подготовки окружения нужно установить зависимости:

```
pip install opencv-python httpx 'httpcore[http2]'
```
# APNS сертификаты

APNS сервера поддерживают два способа подписывания запросов — с помощью сертификатов и с помощью ключей. Метод с ключами более современный и может быть рекомендован для production-ready решений. Однако в силу простоты реализации в этой тестовой утилите используется флоу подписывания с сертификатом.

Нужно иметь ввиду что сертификат выпускается для конкретного приложения (Bundle ID) и окружения (sandbox / production). Для тестирования звонков нужно сгенерировать сертификат в точности для того Bundle ID с которым будет собираться ваше приложение. Можно выпустить сертификат сразу для двух окружений (Sandbox & Production). После выгрузки из ключницы сертификат и приватный ключ нужно сконвертировать в PEM формат.

```
openssl x509 -in apns_cert.cer -inform DER -out apns_cert.pem
openssl pkcs12 -legacy -in apns_key.p12 -nocerts -nodes -out apns_key.pem
```

# Конфигурация приложения

В приложении должны быть обязательно включены как минимум три Background режима (настраиваются в Signing and Capabilities таргета или Info.plist): `audio`, `voip`, `remote-notification`. При использовании `.entitlements` файла там указывается окружение. Окружение должно соответствовать типу с которым собирается приложение. Development окружение используется только для development (отладочных) сборок. Все сборки, в том числе adhoc тестовые сборки собираются с production окружением.

# Тестирование звонков

**Bundle ID** нужно ввести в тестовую утилиту в том виде как он указан в самом приложении. При отправке VOIP-пуша используется Bundle ID с суффиксом `.voip`, тестовая утилита сама допишет этот суффкис при отправке пуша.

**APNS Host** выбирается в соответствии с окружением указанным в `.entitlements` файле с которым собирается приложение.

**Certificate file** и **Private key file** по умолчанию ищутся с указанными именами в папке с утилитой, однако можно указать на любой файл.

**Device token** получается с устройства в виде текста, либо можно считать QR код со строкой содержащей токен. Токен должен быть получен из `PKPushRegistry` где указан `desiredPushTypes = [.voIP]`.

**Room alias** — комната livedigital в которой будет осуществляться тестовый звонок. Комнату можно создать на https://edu.livedigital.space/. Для тестирования можно открыть комнату по указанной ссылке на ПК чтобы при звонке в комнате было два участника. Если ссылка на комнату https://edu.livedigital.space/room/q3_5V3uwik, то её alias это `q3_5V3uwik`.

При начале тестирование нужно добиться получения входящего звонка сначала при активном приложении, убедиться что звонок появляется в системном журнале звонков, и только после этого переходить к тестированию со свёрнутым или не запущенным приложением.

При многократной неуспешной доставке или неуспешной обработке пуша на тестовом устройсте APNS может прекратить доставку пушей в приложение. Если наблюдаются проблемы с доставкой и обработкой, нужно отправлять тестовые пуши экономно. Если всё-таки возникла ситуация когда пуш успешно отправляется (нет ошибок в логах тестовой утилиты), но при этом не доставляется в приложение, возможно система приостановила доставку из-за множества неудачных попыток. Нужно
* удалить приложение с устройства
* перевести время на устройстве вперёд на несколько дней
* перезагрузить телефон
* перевести время на актуальное
* снова перезагрузить телефон
* установить приложение заново

Это сбросит все ограничения установленные системой на приложение.
